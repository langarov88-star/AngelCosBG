<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AngelCosmetics Listing Assistant</title>
  <style>
    :root{--border:#e6e6e6;--shadow:0 10px 30px rgba(0,0,0,.06);--r:16px;--r2:12px}
    body{margin:0;background:#fafafa;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1040px;margin:32px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:22px;margin:0}
    label{display:block;margin:10px 0 6px;font-size:13px;color:#222}
    select,input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:var(--r2);font-size:14px;background:#fff}
    textarea{resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:var(--r2);border:1px solid #ddd;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border:0}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{font-size:12px;color:#777;margin-top:6px}
    .err{color:#c00;font-size:14px;min-height:18px;margin-top:10px;white-space:pre-wrap}
    .ok{color:#0a7a2f;font-size:13px;margin-top:8px;white-space:pre-wrap}
    .gate{max-width:420px;margin:60px auto;padding:0 14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chk{display:flex;align-items:center;gap:8px;font-size:14px}
    .divider{height:1px;background:#eee;margin:14px 0}
    .small{font-size:12px;color:#555}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444;background:#fff}
  </style>
</head>
<body>

<noscript>
  <div class="gate">
    <div class="card">
      <h1>JavaScript е изключен</h1>
      <p class="small">За да работи инструментът, включи JavaScript в браузъра.</p>
    </div>
  </div>
</noscript>

<!-- gate по подразбиране е ВИДИМ, за да няма “бял екран” -->
<div id="gate" class="gate" style="display:block">
  <div class="card">
    <h1>Достъп</h1>
    <p class="small">Въведи парола, за да заредиш инструмента.</p>
    <input id="pw" type="password" placeholder="Парола" autocomplete="current-password">
    <div class="row">
      <label class="chk"><input id="remember" type="checkbox"> Запомни ме</label>
      <span class="muted">(по избор)</span>
    </div>
    <button id="login" type="button" class="primary" style="width:100%;margin-top:10px">Влез</button>
    <div id="gateMsg" class="err"></div>
    <div class="muted" style="margin-top:10px">
      Ако виждаш екрана, но бутоните не реагират, вероятно `_headers`/CSP блокира inline script.
    </div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="top">
    <div>
      <h1>AngelCosmetics Listing Assistant</h1>
      <div class="muted">Генерира листинг за angelcosmetics.bg по фиксирана структура. <span class="pill">BG</span></div>
    </div>
    <div class="actions">
      <button id="logout" type="button">Изход</button>
      <button id="importBtn" type="button">Импорт от конкурентни URL-и</button>
      <!-- ВАЖНО: id="generate" -->
      <button id="generate" type="button" class="primary">Генерирай листинг</button>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label for="brandName">Brand / Shop name (по желание)</label>
        <input id="brandName" placeholder="AngelCosmetics.bg">
        <div class="muted">По желание — ако искаш да се включи в тона/CTA.</div>
      </div>

      <div>
        <label for="tone">Тон / стил (по желание)</label>
        <input id="tone" placeholder="професионално, ясно, продаващо, без излишни обещания">
        <div class="muted">Кратко описание на стила.</div>
      </div>
    </div>

    <div class="divider"></div>

    <label for="urls">Конкурентни URL-и (по 1 на ред) — zlatnaribka.com, arlen.bg, notino.com и др.</label>
    <textarea id="urls" style="min-height:120px" placeholder="https://zlatnaribka.com/...
https://arlen.bg/...
https://www.notino.com/..."></textarea>
    <div class="muted">Ще извлечем публичен текст от страниците и ще го използваме като ориентир (без копиране 1:1).</div>

    <label for="productInfo">Твоят продукт</label>
    <textarea id="productInfo" style="min-height:160px" placeholder="Име, серия, тип, размер/мл, за кого е, проблем, ключови активни съставки, какво да НЕ се казва, ценова група, уникални предимства..."></textarea>

    <label for="competitorNotes">Извлечена информация от конкуренти (автоматично се попълва след импорт, можеш и ръчно)</label>
    <textarea id="competitorNotes" style="min-height:140px" placeholder="След импорт ще се появи тук..."></textarea>

    <label for="result">Готов листинг</label>
    <textarea id="result" style="min-height:340px" placeholder="Тук ще се появи готовият листинг..."></textarea>

    <div id="statusOk" class="ok"></div>
    <div id="appMsg" class="err"></div>
  </div>
</div>

<script>
(() => {
  try {
    const KEY = "angel_listing_token_v1";

    const gate = document.getElementById("gate");
    const app = document.getElementById("app");
    const pw = document.getElementById("pw");
    const remember = document.getElementById("remember");
    const gateMsg = document.getElementById("gateMsg");

    const appMsg = document.getElementById("appMsg");
    const statusOk = document.getElementById("statusOk");

    const brandName = document.getElementById("brandName");
    const tone = document.getElementById("tone");
    const urls = document.getElementById("urls");
    const productInfo = document.getElementById("productInfo");
    const competitorNotes = document.getElementById("competitorNotes");
    const result = document.getElementById("result");

    const btnImport = document.getElementById("importBtn");
    const btnGen = document.getElementById("generate");
    const btnLogout = document.getElementById("logout");
    const btnLogin = document.getElementById("login");

    // бърз индикатор, че JS работи
    if (statusOk) statusOk.textContent = "JS зареден ✓";
    window.__angelAppLoaded = true;

    // показваме runtime грешки на екрана вместо “бяло”
    window.addEventListener("error", (e) => {
      try {
        if (app) app.style.display = "none";
        if (gate) gate.style.display = "block";
        if (gateMsg) gateMsg.textContent = "JS error: " + (e?.message || String(e));
      } catch {}
    });

    window.addEventListener("unhandledrejection", (e) => {
      try {
        if (app) app.style.display = "none";
        if (gate) gate.style.display = "block";
        if (gateMsg) gateMsg.textContent = "Promise error: " + String(e?.reason?.message || e?.reason || e);
      } catch {}
    });

    function getToken() {
      return sessionStorage.getItem(KEY) || localStorage.getItem(KEY) || "";
    }
    function setToken(token, persist) {
      sessionStorage.removeItem(KEY);
      localStorage.removeItem(KEY);
      (persist ? localStorage : sessionStorage).setItem(KEY, token);
    }
    function clearToken() {
      sessionStorage.removeItem(KEY);
      localStorage.removeItem(KEY);
    }

    function clearMessages() {
      if (appMsg) appMsg.textContent = "";
      if (gateMsg) gateMsg.textContent = "";
      // statusOk не чистим напълно, за да виждаш “JS зареден ✓”
    }

    function showApp() {
      if (gate) gate.style.display = "none";
      if (app) app.style.display = "block";
      if (gateMsg) gateMsg.textContent = "";
      if (pw) pw.value = "";
      clearMessages();
    }

    function showGate(msg = "") {
      if (app) app.style.display = "none";
      if (gate) gate.style.display = "block";
      if (gateMsg) gateMsg.textContent = msg;
      if (pw) pw.value = "";
    }

    function setLoading(isLoading, msg = "") {
      if (btnImport) btnImport.disabled = isLoading;
      if (btnGen) btnGen.disabled = isLoading;
      if (btnLogout) btnLogout.disabled = isLoading;
      if (statusOk) statusOk.textContent = msg || (window.__angelAppLoaded ? "JS зареден ✓" : "");
    }

    async function safeJson(r) {
      const text = await r.text();
      try { return { data: JSON.parse(text), raw: text }; }
      catch { return { data: { error: text }, raw: text }; }
    }

    function normalizeUrlLines(text) {
      const lines = String(text || "")
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      const out = [];
      for (const line of lines) {
        if (!/^https?:\/\//i.test(line)) continue;
        if (line.includes("...")) continue;
        out.push(line);
      }
      return Array.from(new Set(out)).slice(0, 10);
    }

    function itemsToNotes(items, header = "") {
      const lines = [];
      if (header) lines.push(header, "---", "");
      for (const it of (items || [])) {
        lines.push(`URL: ${it.url || ""}`);
        if (it.error) {
          lines.push(`ERROR: ${it.error}`);
        } else {
          if (it.title) lines.push(`TITLE: ${it.title}`);
          if (it.text) lines.push(`TEXT:\n${it.text}`);
        }
        lines.push("", "---", "");
      }
      return lines.join("\n").trim();
    }

    async function login() {
      if (gateMsg) gateMsg.textContent = "";
      const password = (pw && pw.value) ? pw.value : "";
      if (!password) {
        if (gateMsg) gateMsg.textContent = "Въведи парола.";
        return;
      }

      try {
        const r = await fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        const { data } = await safeJson(r);
        if (!r.ok) throw new Error(data?.error || `Auth failed (${r.status})`);
        if (!data?.token) throw new Error("Missing token from server");

        setToken(data.token, remember && remember.checked);
        showApp();
      } catch (e) {
        showGate(String(e?.message || e));
      }
    }

    async function importCompetitors() {
      clearMessages();

      const token = getToken();
      if (!token) return showGate("Моля, влез отново.");

      const list = normalizeUrlLines(urls && urls.value);

      // ако няма URL-и -> /api/research
      if (!list.length) {
        const pi = (productInfo && productInfo.value ? productInfo.value : "").trim();
        if (!pi) {
          if (appMsg) appMsg.textContent = "За автоматично търсене попълни първо “Твоят продукт”.";
          return;
        }

        setLoading(true, "Търся в мрежата по описанието...");
        if (competitorNotes) competitorNotes.value = "Търся...\n";

        try {
          const r = await fetch("/api/research", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ product_info: pi })
          });

          const { data } = await safeJson(r);

          if (r.status === 401) {
            clearToken();
            if (competitorNotes) competitorNotes.value = "";
            return showGate(data?.error || "Сесията е изтекла. Влез отново.");
          }
          if (!r.ok) throw new Error(data?.error || `Research failed (${r.status})`);

          const items = Array.isArray(data?.items) ? data.items : [];
          if (competitorNotes) competitorNotes.value = itemsToNotes(items, `SEARCH QUERY: ${data?.query || ""}`);
          if (statusOk) statusOk.textContent = `Research готов: ${items.length} източника.`;

        } catch (e) {
          if (competitorNotes) competitorNotes.value = "";
          if (appMsg) appMsg.textContent = String(e?.message || e);
        } finally {
          setLoading(false);
        }

        return;
      }

      // ако има URL-и -> /api/import
      setLoading(true, `Импортирам (${list.length}) URL-и...`);
      if (competitorNotes) competitorNotes.value = "Импортирам...\n";

      try {
        const r = await fetch("/api/import", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ urls: list })
        });

        const { data } = await safeJson(r);

        if (r.status === 401) {
          clearToken();
          if (competitorNotes) competitorNotes.value = "";
          return showGate(data?.error || "Сесията е изтекла. Влез отново.");
        }
        if (!r.ok) throw new Error(data?.error || `Import failed (${r.status})`);

        const items = Array.isArray(data?.items) ? data.items : [];
        if (competitorNotes) competitorNotes.value = itemsToNotes(items, `IMPORTED URLS: ${items.length}`);
        if (statusOk) statusOk.textContent = `Импорт готов: ${items.length} страници.`;

      } catch (e) {
        if (competitorNotes) competitorNotes.value = "";
        if (appMsg) appMsg.textContent = String(e?.message || e);
      } finally {
        setLoading(false);
      }
    }

    async function runGenerate() {
      clearMessages();
      if (result) result.value = "Генерирам...";

      const token = getToken();
      if (!token) {
        if (result) result.value = "";
        return showGate("Моля, влез отново.");
      }

      const pi = (productInfo && productInfo.value ? productInfo.value : "").trim();
      if (!pi) {
        if (result) result.value = "";
        if (appMsg) appMsg.textContent = "Полето “Твоят продукт” е задължително.";
        return;
      }

      setLoading(true, "Генерирам листинг...");

      const payload = {
        shop_name: (brandName && brandName.value ? brandName.value : "").trim(),
        tone: (tone && tone.value ? tone.value : "").trim(),
        product_info: pi,
        competitor_notes: (competitorNotes && competitorNotes.value ? competitorNotes.value : "").trim()
      };

      try {
        const r = await fetch("/api/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const { data } = await safeJson(r);

        if (r.status === 401) {
          clearToken();
          if (result) result.value = "";
          return showGate(data?.error || "Сесията е изтекла. Влез отново.");
        }
        if (!r.ok) throw new Error(data?.error || `Request failed (${r.status})`);

        if (result) result.value = data?.output || "";
        if (statusOk) statusOk.textContent = "Готово.";

      } catch (e) {
        if (result) result.value = "";
        if (appMsg) appMsg.textContent = String(e?.message || e);
      } finally {
        setLoading(false);
      }
    }

    // Bind events (safe + onclick fallback)
    if (btnLogin) {
      btnLogin.onclick = login;
      btnLogin.addEventListener("click", login);
    }
    if (pw) {
      pw.addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    }
    if (btnLogout) {
      btnLogout.onclick = () => { clearToken(); showGate(""); };
      btnLogout.addEventListener("click", () => { clearToken(); showGate(""); });
    }
    if (btnImport) {
      btnImport.onclick = importCompetitors;
      btnImport.addEventListener("click", importCompetitors);
    }
    if (btnGen) {
      btnGen.onclick = runGenerate;
      btnGen.addEventListener("click", runGenerate);
    } else {
      // ако някой пак е счупил id-то, да го видиш веднага
      if (statusOk) statusOk.textContent = "Липсва бутон #generate (провери id).";
    }

    // Init
    if (getToken()) showApp();
    else showGate("");

  } catch (e) {
    const gate = document.getElementById("gate");
    const app = document.getElementById("app");
    const gateMsg = document.getElementById("gateMsg");
    if (app) app.style.display = "none";
    if (gate) gate.style.display = "block";
    if (gateMsg) gateMsg.textContent = "JS error: " + String(e?.message || e);
  }
})();
</script>

</body>
</html>
