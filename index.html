<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AngelCosmetics Listing Assistant</title>
  <style>
    :root{--border:#e6e6e6;--shadow:0 10px 30px rgba(0,0,0,.06);--r:16px;--r2:12px}
    body{margin:0;background:#fafafa;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1040px;margin:32px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:22px;margin:0}
    label{display:block;margin:10px 0 6px;font-size:13px;color:#222}
    select,input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:var(--r2);font-size:14px;background:#fff}
    textarea{resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:var(--r2);border:1px solid #ddd;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border:0}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{font-size:12px;color:#777;margin-top:6px}
    .err{color:#c00;font-size:14px;min-height:18px;margin-top:10px;white-space:pre-wrap}
    .ok{color:#0a7a2f;font-size:13px;margin-top:8px;white-space:pre-wrap}
    .gate{max-width:420px;margin:60px auto;padding:0 14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chk{display:flex;align-items:center;gap:8px;font-size:14px}
    .divider{height:1px;background:#eee;margin:14px 0}
    .small{font-size:12px;color:#555}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444;background:#fff}

    /* AI Chat Assistant Styles */
    .chat-toggle{position:fixed;bottom:24px;right:24px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;cursor:pointer;box-shadow:0 4px 20px rgba(102,126,234,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;transition:transform 0.2s,box-shadow 0.2s}
    .chat-toggle:hover{transform:scale(1.05);box-shadow:0 6px 25px rgba(102,126,234,0.5)}
    .chat-toggle svg{width:28px;height:28px;fill:#fff}
    .chat-toggle .close-icon{display:none}
    .chat-toggle.active .chat-icon{display:none}
    .chat-toggle.active .close-icon{display:block}

    .chat-window{position:fixed;bottom:100px;right:24px;width:380px;max-width:calc(100vw - 48px);height:520px;max-height:calc(100vh - 140px);background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.15);z-index:9998;display:none;flex-direction:column;overflow:hidden}
    .chat-window.open{display:flex}

    .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px 20px;display:flex;align-items:center;gap:12px}
    .chat-header-avatar{width:40px;height:40px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .chat-header-avatar svg{width:24px;height:24px;fill:#fff}
    .chat-header-info h3{margin:0;font-size:15px;font-weight:600}
    .chat-header-info p{margin:2px 0 0;font-size:12px;opacity:0.9}

    .chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#f8f9fa}
    .chat-message{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;word-wrap:break-word}
    .chat-message.user{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
    .chat-message.assistant{background:#fff;color:#333;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .chat-message.typing{background:#fff;color:#666;font-style:italic}
    .chat-message.typing::after{content:'';animation:dots 1.5s infinite}
    @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}

    .chat-input-area{padding:12px 16px;background:#fff;border-top:1px solid #eee;display:flex;gap:10px;align-items:flex-end}
    .chat-input{flex:1;padding:12px 16px;border:1px solid #e0e0e0;border-radius:24px;font-size:14px;resize:none;max-height:100px;line-height:1.4;font-family:inherit}
    .chat-input:focus{outline:none;border-color:#667eea}
    .chat-send{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform 0.2s}
    .chat-send:hover{transform:scale(1.05)}
    .chat-send:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .chat-send svg{width:20px;height:20px;fill:#fff}

    .chat-welcome{text-align:center;padding:20px;color:#666}
    .chat-welcome h4{margin:0 0 8px;color:#333;font-size:16px}
    .chat-welcome p{margin:0;font-size:13px}

    @media(max-width:480px){
      .chat-window{bottom:0;right:0;width:100%;max-width:100%;height:100%;max-height:100%;border-radius:0}
      .chat-toggle{bottom:16px;right:16px;width:56px;height:56px}
    }
  </style>
</head>
<body>

<noscript>
  <div class="gate">
    <div class="card">
      <h1>JavaScript е изключен</h1>
      <p class="small">За да работи инструментът, включи JavaScript в браузъра.</p>
    </div>
  </div>
</noscript>

<!-- gate по подразбиране е ВИДИМ, за да няма “бял екран” -->
<div id="gate" class="gate" style="display:block">
  <div class="card">
    <h1>Достъп</h1>
    <p class="small">Въведи парола, за да заредиш инструмента.</p>
    <input id="pw" type="password" placeholder="Парола" autocomplete="current-password">
    <div class="row">
      <label class="chk"><input id="remember" type="checkbox"> Запомни ме</label>
      <span class="muted">(по избор)</span>
    </div>
    <button id="login" type="button" class="primary" style="width:100%;margin-top:10px">Влез</button>
    <div id="gateMsg" class="err"></div>
    <div class="muted" style="margin-top:10px">
      Ако виждаш екрана, но бутоните не реагират, вероятно `_headers`/CSP блокира inline script.
    </div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="top">
    <div>
      <h1>AngelCosmetics Listing Assistant</h1>
      <div class="muted">Генерира листинг за angelcosmetics.bg по фиксирана структура. <span class="pill">BG</span></div>
    </div>
    <div class="actions">
      <button id="logout" type="button">Изход</button>
      <button id="importBtn" type="button">Импорт от конкурентни URL-и</button>
      <!-- ВАЖНО: id="generate" -->
      <button id="generate" type="button" class="primary">Генерирай листинг</button>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label for="brandName">Brand / Shop name (по желание)</label>
        <input id="brandName" placeholder="AngelCosmetics.bg">
        <div class="muted">По желание — ако искаш да се включи в тона/CTA.</div>
      </div>

      <div>
        <label for="tone">Тон / стил (по желание)</label>
        <input id="tone" placeholder="професионално, ясно, продаващо, без излишни обещания">
        <div class="muted">Кратко описание на стила.</div>
      </div>
    </div>

    <div class="divider"></div>

    <label for="urls">Конкурентни URL-и (по 1 на ред) — zlatnaribka.com, arlen.bg, notino.com и др.</label>
    <textarea id="urls" style="min-height:120px" placeholder="https://zlatnaribka.com/...
https://arlen.bg/...
https://www.notino.com/..."></textarea>
    <div class="muted">Ще извлечем публичен текст от страниците и ще го използваме като ориентир (без копиране 1:1).</div>

    <label for="productInfo">Твоят продукт</label>
    <textarea id="productInfo" style="min-height:160px" placeholder="Име, серия, тип, размер/мл, за кого е, проблем, ключови активни съставки, какво да НЕ се казва, ценова група, уникални предимства..."></textarea>

    <label for="competitorNotes">Извлечена информация от конкуренти (автоматично се попълва след импорт, можеш и ръчно)</label>
    <textarea id="competitorNotes" style="min-height:140px" placeholder="След импорт ще се появи тук..."></textarea>

    <label for="result">Готов листинг</label>
    <textarea id="result" style="min-height:340px" placeholder="Тук ще се появи готовият листинг..."></textarea>

    <div id="statusOk" class="ok"></div>
    <div id="appMsg" class="err"></div>
  </div>
</div>

<!-- AI Chat Assistant -->
<button id="chatToggle" class="chat-toggle" title="AI Асистент">
  <svg class="chat-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
    <circle cx="8" cy="10" r="1.5"/>
    <circle cx="12" cy="10" r="1.5"/>
    <circle cx="16" cy="10" r="1.5"/>
  </svg>
  <svg class="close-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
  </svg>
</button>

<div id="chatWindow" class="chat-window">
  <div class="chat-header">
    <div class="chat-header-avatar">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
      </svg>
    </div>
    <div class="chat-header-info">
      <h3>Angel Cosmetics AI</h3>
      <p>Твоят козметичен консултант</p>
    </div>
  </div>

  <div id="chatMessages" class="chat-messages">
    <div class="chat-welcome">
      <h4>Здравей!</h4>
      <p>Аз съм AI асистентът на Angel Cosmetics. Мога да ти помогна с въпроси за козметика, грижа за кожата и косата. Питай ме!</p>
    </div>
  </div>

  <div class="chat-input-area">
    <textarea id="chatInput" class="chat-input" placeholder="Напиши съобщение..." rows="1"></textarea>
    <button id="chatSend" class="chat-send" title="Изпрати">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>
</div>

<script>
(() => {
  try {
    const KEY = "angel_listing_token_v1";

    const gate = document.getElementById("gate");
    const app = document.getElementById("app");
    const pw = document.getElementById("pw");
    const remember = document.getElementById("remember");
    const gateMsg = document.getElementById("gateMsg");

    const appMsg = document.getElementById("appMsg");
    const statusOk = document.getElementById("statusOk");

    const brandName = document.getElementById("brandName");
    const tone = document.getElementById("tone");
    const urls = document.getElementById("urls");
    const productInfo = document.getElementById("productInfo");
    const competitorNotes = document.getElementById("competitorNotes");
    const result = document.getElementById("result");

    const btnImport = document.getElementById("importBtn");
    const btnGen = document.getElementById("generate");
    const btnLogout = document.getElementById("logout");
    const btnLogin = document.getElementById("login");

    // бърз индикатор, че JS работи
    if (statusOk) statusOk.textContent = "JS зареден ✓";
    window.__angelAppLoaded = true;

    // показваме runtime грешки на екрана вместо “бяло”
    window.addEventListener("error", (e) => {
      try {
        if (app) app.style.display = "none";
        if (gate) gate.style.display = "block";
        if (gateMsg) gateMsg.textContent = "JS error: " + (e?.message || String(e));
      } catch {}
    });

    window.addEventListener("unhandledrejection", (e) => {
      try {
        if (app) app.style.display = "none";
        if (gate) gate.style.display = "block";
        if (gateMsg) gateMsg.textContent = "Promise error: " + String(e?.reason?.message || e?.reason || e);
      } catch {}
    });

    function getToken() {
      return sessionStorage.getItem(KEY) || localStorage.getItem(KEY) || "";
    }
    function setToken(token, persist) {
      sessionStorage.removeItem(KEY);
      localStorage.removeItem(KEY);
      (persist ? localStorage : sessionStorage).setItem(KEY, token);
    }
    function clearToken() {
      sessionStorage.removeItem(KEY);
      localStorage.removeItem(KEY);
    }

    function clearMessages() {
      if (appMsg) appMsg.textContent = "";
      if (gateMsg) gateMsg.textContent = "";
      // statusOk не чистим напълно, за да виждаш “JS зареден ✓”
    }

    function showApp() {
      if (gate) gate.style.display = "none";
      if (app) app.style.display = "block";
      if (gateMsg) gateMsg.textContent = "";
      if (pw) pw.value = "";
      clearMessages();
    }

    function showGate(msg = "") {
      if (app) app.style.display = "none";
      if (gate) gate.style.display = "block";
      if (gateMsg) gateMsg.textContent = msg;
      if (pw) pw.value = "";
    }

    function setLoading(isLoading, msg = "") {
      if (btnImport) btnImport.disabled = isLoading;
      if (btnGen) btnGen.disabled = isLoading;
      if (btnLogout) btnLogout.disabled = isLoading;
      if (statusOk) statusOk.textContent = msg || (window.__angelAppLoaded ? "JS зареден ✓" : "");
    }

    async function safeJson(r) {
      const text = await r.text();
      try { return { data: JSON.parse(text), raw: text }; }
      catch { return { data: { error: text }, raw: text }; }
    }

    function normalizeUrlLines(text) {
      const lines = String(text || "")
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      const out = [];
      for (const line of lines) {
        if (!/^https?:\/\//i.test(line)) continue;
        if (line.includes("...")) continue;
        out.push(line);
      }
      return Array.from(new Set(out)).slice(0, 10);
    }

    function itemsToNotes(items, header = "") {
      const lines = [];
      if (header) lines.push(header, "---", "");
      for (const it of (items || [])) {
        lines.push(`URL: ${it.url || ""}`);
        if (it.error) {
          lines.push(`ERROR: ${it.error}`);
        } else {
          if (it.title) lines.push(`TITLE: ${it.title}`);
          if (it.text) lines.push(`TEXT:\n${it.text}`);
        }
        lines.push("", "---", "");
      }
      return lines.join("\n").trim();
    }

    async function login() {
      if (gateMsg) gateMsg.textContent = "";
      const password = (pw && pw.value) ? pw.value : "";
      if (!password) {
        if (gateMsg) gateMsg.textContent = "Въведи парола.";
        return;
      }

      try {
        const r = await fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        const { data } = await safeJson(r);
        if (!r.ok) throw new Error(data?.error || `Auth failed (${r.status})`);
        if (!data?.token) throw new Error("Missing token from server");

        setToken(data.token, remember && remember.checked);
        showApp();
      } catch (e) {
        showGate(String(e?.message || e));
      }
    }

    async function importCompetitors() {
      clearMessages();

      const token = getToken();
      if (!token) return showGate("Моля, влез отново.");

      const list = normalizeUrlLines(urls && urls.value);

      // ако няма URL-и -> /api/research
      if (!list.length) {
        const pi = (productInfo && productInfo.value ? productInfo.value : "").trim();
        if (!pi) {
          if (appMsg) appMsg.textContent = "За автоматично търсене попълни първо “Твоят продукт”.";
          return;
        }

        setLoading(true, "Търся в мрежата по описанието...");
        if (competitorNotes) competitorNotes.value = "Търся...\n";

        try {
          const r = await fetch("/api/research", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ product_info: pi })
          });

          const { data } = await safeJson(r);

          if (r.status === 401) {
            clearToken();
            if (competitorNotes) competitorNotes.value = "";
            return showGate(data?.error || "Сесията е изтекла. Влез отново.");
          }
          if (!r.ok) throw new Error(data?.error || `Research failed (${r.status})`);

          const items = Array.isArray(data?.items) ? data.items : [];
          if (competitorNotes) competitorNotes.value = itemsToNotes(items, `SEARCH QUERY: ${data?.query || ""}`);
          if (statusOk) statusOk.textContent = `Research готов: ${items.length} източника.`;

        } catch (e) {
          if (competitorNotes) competitorNotes.value = "";
          if (appMsg) appMsg.textContent = String(e?.message || e);
        } finally {
          setLoading(false);
        }

        return;
      }

      // ако има URL-и -> /api/import
      setLoading(true, `Импортирам (${list.length}) URL-и...`);
      if (competitorNotes) competitorNotes.value = "Импортирам...\n";

      try {
        const r = await fetch("/api/import", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ urls: list })
        });

        const { data } = await safeJson(r);

        if (r.status === 401) {
          clearToken();
          if (competitorNotes) competitorNotes.value = "";
          return showGate(data?.error || "Сесията е изтекла. Влез отново.");
        }
        if (!r.ok) throw new Error(data?.error || `Import failed (${r.status})`);

        const items = Array.isArray(data?.items) ? data.items : [];
        if (competitorNotes) competitorNotes.value = itemsToNotes(items, `IMPORTED URLS: ${items.length}`);
        if (statusOk) statusOk.textContent = `Импорт готов: ${items.length} страници.`;

      } catch (e) {
        if (competitorNotes) competitorNotes.value = "";
        if (appMsg) appMsg.textContent = String(e?.message || e);
      } finally {
        setLoading(false);
      }
    }

    async function runGenerate() {
      clearMessages();
      if (result) result.value = "Генерирам...";

      const token = getToken();
      if (!token) {
        if (result) result.value = "";
        return showGate("Моля, влез отново.");
      }

      const pi = (productInfo && productInfo.value ? productInfo.value : "").trim();
      if (!pi) {
        if (result) result.value = "";
        if (appMsg) appMsg.textContent = "Полето “Твоят продукт” е задължително.";
        return;
      }

      setLoading(true, "Генерирам листинг...");

      const payload = {
        shop_name: (brandName && brandName.value ? brandName.value : "").trim(),
        tone: (tone && tone.value ? tone.value : "").trim(),
        product_info: pi,
        competitor_notes: (competitorNotes && competitorNotes.value ? competitorNotes.value : "").trim()
      };

      try {
        const r = await fetch("/api/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const { data } = await safeJson(r);

        if (r.status === 401) {
          clearToken();
          if (result) result.value = "";
          return showGate(data?.error || "Сесията е изтекла. Влез отново.");
        }
        if (!r.ok) throw new Error(data?.error || `Request failed (${r.status})`);

        if (result) result.value = data?.output || "";
        if (statusOk) statusOk.textContent = "Готово.";

      } catch (e) {
        if (result) result.value = "";
        if (appMsg) appMsg.textContent = String(e?.message || e);
      } finally {
        setLoading(false);
      }
    }

    // Bind events (safe + onclick fallback)
    if (btnLogin) {
      btnLogin.onclick = login;
      btnLogin.addEventListener("click", login);
    }
    if (pw) {
      pw.addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    }
    if (btnLogout) {
      btnLogout.onclick = () => { clearToken(); showGate(""); };
      btnLogout.addEventListener("click", () => { clearToken(); showGate(""); });
    }
    if (btnImport) {
      btnImport.onclick = importCompetitors;
      btnImport.addEventListener("click", importCompetitors);
    }
    if (btnGen) {
      btnGen.onclick = runGenerate;
      btnGen.addEventListener("click", runGenerate);
    } else {
      // ако някой пак е счупил id-то, да го видиш веднага
      if (statusOk) statusOk.textContent = "Липсва бутон #generate (провери id).";
    }

    // Init
    if (getToken()) showApp();
    else showGate("");

  } catch (e) {
    const gate = document.getElementById("gate");
    const app = document.getElementById("app");
    const gateMsg = document.getElementById("gateMsg");
    if (app) app.style.display = "none";
    if (gate) gate.style.display = "block";
    if (gateMsg) gateMsg.textContent = "JS error: " + String(e?.message || e);
  }
})();

// AI Chat Assistant
(() => {
  try {
    const chatToggle = document.getElementById("chatToggle");
    const chatWindow = document.getElementById("chatWindow");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    let chatHistory = [];
    let isWaitingForResponse = false;

    // Toggle chat window
    if (chatToggle && chatWindow) {
      chatToggle.addEventListener("click", () => {
        chatWindow.classList.toggle("open");
        chatToggle.classList.toggle("active");
        if (chatWindow.classList.contains("open") && chatInput) {
          setTimeout(() => chatInput.focus(), 100);
        }
      });
    }

    // Auto-resize textarea
    if (chatInput) {
      chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + "px";
      });

      // Send on Enter (but not Shift+Enter)
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Send button click
    if (chatSend) {
      chatSend.addEventListener("click", sendMessage);
    }

    function addMessage(content, role) {
      if (!chatMessages) return;

      // Remove welcome message if exists
      const welcome = chatMessages.querySelector(".chat-welcome");
      if (welcome) welcome.remove();

      const msgDiv = document.createElement("div");
      msgDiv.className = `chat-message ${role}`;
      msgDiv.textContent = content;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return msgDiv;
    }

    function showTyping() {
      if (!chatMessages) return null;

      const typingDiv = document.createElement("div");
      typingDiv.className = "chat-message assistant typing";
      typingDiv.id = "typingIndicator";
      typingDiv.textContent = "Пиша";
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return typingDiv;
    }

    function removeTyping() {
      const typing = document.getElementById("typingIndicator");
      if (typing) typing.remove();
    }

    function setInputEnabled(enabled) {
      if (chatInput) chatInput.disabled = !enabled;
      if (chatSend) chatSend.disabled = !enabled;
      isWaitingForResponse = !enabled;
    }

    async function sendMessage() {
      if (isWaitingForResponse) return;
      if (!chatInput) return;

      const message = chatInput.value.trim();
      if (!message) return;

      // Clear input and add user message
      chatInput.value = "";
      chatInput.style.height = "auto";
      addMessage(message, "user");

      // Add to history
      chatHistory.push({ role: "user", content: message });

      // Show typing indicator
      setInputEnabled(false);
      showTyping();

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: message,
            history: chatHistory.slice(0, -1) // Don't include the last message we just added
          })
        });

        const data = await response.json();
        removeTyping();

        if (!response.ok) {
          throw new Error(data?.error || "Грешка при изпращане");
        }

        const assistantMessage = data?.response || "Съжалявам, не успях да генерирам отговор.";
        addMessage(assistantMessage, "assistant");
        chatHistory.push({ role: "assistant", content: assistantMessage });

        // Keep history manageable (last 20 messages)
        if (chatHistory.length > 20) {
          chatHistory = chatHistory.slice(-20);
        }

      } catch (e) {
        removeTyping();
        addMessage("Съжалявам, възникна грешка. Моля, опитай отново.", "assistant");
        console.error("Chat error:", e);
      } finally {
        setInputEnabled(true);
        if (chatInput) chatInput.focus();
      }
    }

  } catch (e) {
    console.error("Chat init error:", e);
  }
})();
</script>

</body>
</html>
